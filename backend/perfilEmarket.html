<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .profile-pic-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid #cbd5e1;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
        }

        .profile-pic-container:hover {
            border-color: #93c5fd;
            transform: scale(1.05);
        }

        .navbar-search-container {
            flex-grow: 1;
            max-width: 600px;
            margin: 0 2rem;
        }

        .sidebar-link.active {
            background-color: #2563eb;
            color: #fff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateX(5px);
        }

        .rotated-icon {
            transform: rotate(180deg);
        }

        .payment-card {
            transition: all 0.3s ease-in-out;
        }

        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between flex-wrap md:flex-nowrap">
            <!-- Logo -->
            <div class="flex items-center space-x-2 mr-4 mb-4 md:mb-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="w-8 h-8 text-white">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                <span class="text-2xl font-bold">Ecommerce.bo</span>
            </div>

            <!-- Search Bar -->
            <div class="navbar-search-container">
                <div class="relative w-full">
                    <input type="text" placeholder="Buscar productos, tiendas..."
                        class="w-full p-2 pl-10 pr-4 rounded-full text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="h-5 w-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- User Actions & Buttons -->
            <div class="flex items-center space-x-4 ml-auto">
                <div class="flex items-center space-x-2 cursor-pointer hover:text-gray-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 11V7a4 4 0 00-8 0v4M4 11h16v10a2 2 0 01-2 2H6a2 2 0 01-2-2v-10z" />
                    </svg>
                    <span class="hidden md:block">Carrito</span>
                </div>
                <div class="flex items-center space-x-2 cursor-pointer hover:text-gray-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="hidden md:block">Mi Perfil</span>
                </div>
                <a href="#"
                    class="bg-amber-500 text-white font-semibold py-2 px-6 rounded-full shadow-lg hover:bg-amber-600 transition-colors">
                    Crear cuenta
                </a>
            </div>
        </div>
        <!-- Sub-nav bar -->
        <div class="bg-blue-950 py-2 hidden md:block">
            <div class="container mx-auto px-4 flex items-center space-x-8">
                <a href="#" class="text-white text-sm font-medium hover:text-gray-300 transition-colors">Todas las
                    categorías</a>
                <a href="#" class="text-white text-sm font-medium hover:text-gray-300 transition-colors">Selecciones
                    destacadas</a>
                <a href="#" class="text-white text-sm font-medium hover:text-gray-300 transition-colors">Centro de
                    Ayuda</a>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="flex-grow container mx-auto px-4 mt-8 flex items-start justify-center">
        <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden md:flex">

            <!-- Sidebar Navigation -->
            <aside
                class="w-full md:w-1/4 bg-gray-50 p-6 md:p-8 rounded-t-2xl md:rounded-l-2xl md:rounded-t-none border-b md:border-b-0 md:border-r border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 hidden md:block">Menú</h2>
                <nav class="space-y-3">
                    <a href="#"
                        class="sidebar-link block p-4 rounded-xl text-gray-700 hover:bg-gray-100 transition-colors duration-200"
                        data-section="account-info">
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span class="font-semibold">Mi Perfil</span>
                        </div>
                    </a>
                    <a href="#"
                        class="sidebar-link block p-4 rounded-xl text-gray-700 hover:bg-gray-100 transition-colors duration-200"
                        data-section="addresses">
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.899a2 2 0 01-2.828 0L6.343 16.657A8 8 0 1117.657 16.657z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="font-semibold">Mis Direcciones</span>
                        </div>
                    </a>
                    <a href="#"
                        class="sidebar-link active block p-4 rounded-xl text-gray-700 bg-white hover:bg-gray-100 transition-colors duration-200 shadow-sm"
                        data-section="order-history">
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 16H7" />
                            </svg>
                            <span class="font-semibold">Historial de Pedidos</span>
                        </div>
                    </a>
                    <a href="#"
                        class="sidebar-link block p-4 rounded-xl text-gray-700 bg-white hover:bg-gray-100 transition-colors duration-200"
                        data-section="payment-methods">
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                            </svg>
                            <span class="font-semibold">Métodos de Pago</span>
                        </div>
                    </a>
                </nav>
            </aside>

            <!-- Main Content Sections -->
            <div class="w-full md:w-3/4 p-8 md:p-12">

                <!-- Loading and Error States -->
                <div id="loading" class="text-center text-gray-500 font-medium my-8" style="display: none;">Cargando
                    perfil...</div>
                <div id="error-message" class="bg-red-100 text-red-700 p-4 rounded-lg my-4" style="display: none;">
                </div>

                <!-- Account Info Section -->
                <div id="account-info-section" class="content-section" style="display:none;">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Mi Perfil</h1>
                    <div class="flex items-center space-x-6 mb-8">
                        <label for="profilePictureInput" class="relative block">
                            <div class="profile-pic-container">
                                <img id="profilePicture" src="https://placehold.co/120x120/E2E8F0/A0AEC0?text=Foto"
                                    alt="Foto de perfil" class="w-full h-full object-cover">
                            </div>
                            <input type="file" id="profilePictureInput" accept="image/*" class="hidden">
                            <div class="absolute bottom-0 right-0 p-2 bg-blue-500 rounded-full text-white shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.586 3H8.414A2 2 0 007 4.414L5.879 5.586A1 1 0 015.172 6H4v1zM6 9a4 4 0 118 0 4 4 0 01-8 0zm2 0a2 2 0 104 0 2 2 0 00-4 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </label>
                        <div class="flex-1">
                            <h2 id="userNameDisplay" class="text-xl font-semibold text-gray-700">Nombre de Usuario</h2>
                            <p class="text-sm text-gray-500">ID: <span id="userIdDisplay">Cargando...</span></p>
                        </div>
                    </div>
                    <form id="profileForm">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="firstName"
                                    class="block text-sm font-medium text-gray-700 mb-1">Nombres</label>
                                <input type="text" id="firstName" name="firstName" required
                                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    disabled>
                            </div>
                            <div>
                                <label for="lastName"
                                    class="block text-sm font-medium text-gray-700 mb-1">Apellidos</label>
                                <input type="text" id="lastName" name="lastName" required
                                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    disabled>
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="email" name="email" required
                                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    disabled>
                            </div>
                            <div>
                                <label for="password"
                                    class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                                <input type="password" id="password" name="password" placeholder="********"
                                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    disabled>
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                <input type="tel" id="phone" name="phone"
                                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    disabled>
                            </div>
                            <div>
                                <label for="ciNit" class="block text-sm font-medium text-gray-700 mb-1">C.I. /
                                    NIT</label>
                                <input type="text" id="ciNit" name="ciNit"
                                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    disabled>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-8 flex flex-wrap gap-4">
                            <button type="button" id="editProfileBtn"
                                class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                                Editar Perfil
                            </button>
                            <button type="submit" id="saveProfileBtn"
                                class="bg-amber-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-amber-600 transition-all duration-300 transform hover:scale-105"
                                style="display: none;">
                                Guardar Cambios
                            </button>
                            <button type="button" id="deleteProfileBtn"
                                class="bg-red-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-red-700 transition-all duration-300 transform hover:scale-105">
                                Eliminar Perfil
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Addresses Section -->
                <div id="addresses-section" class="content-section" style="display: none;">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Mis Direcciones</h1>
                    <div class="mt-4 text-center text-sm text-gray-500 md:text-left">
                        <p class="font-semibold text-gray-700 mb-2">ID de Usuario:</p>
                        <div class="bg-gray-200 p-2 rounded-lg break-words">
                            <span id="userIdDisplayAddresses">Cargando...</span>
                        </div>
                    </div>
                    <ul id="addressList" class="space-y-4 my-6"></ul>
                    <button id="addAddressBtn"
                        class="w-full bg-amber-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-amber-600 transition-all duration-300 transform hover:scale-105 mt-4">
                        Agregar Dirección
                    </button>
                    <div id="addressFormContainer" class="mt-4 p-4 bg-white rounded-xl shadow-lg border border-gray-200"
                        style="display: none;">
                        <h3 class="text-xl font-semibold mb-3">Nueva Dirección</h3>
                        <form id="addressForm" class="space-y-3">
                            <input type="text" id="departamento" placeholder="Departamento" required
                                class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="provincia" placeholder="Provincia" required
                                class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="ciudad" placeholder="Ciudad" required
                                class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="zona" placeholder="Zona"
                                class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="calle" placeholder="Calle" required
                                class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="numero" placeholder="Número" required
                                class="w-full p-2 border border-gray-300 rounded-lg">
                            <textarea id="referencias" placeholder="Referencias" rows="2"
                                class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="isPrimary" class="rounded text-blue-600 focus:ring-blue-500">
                                <label for="isPrimary" class="text-sm text-gray-700">Principal</label>
                            </div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors">Guardar</button>
                                <button type="button" id="cancelAddressBtn"
                                    class="w-full bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Order History Section -->
                <div id="order-history-section" class="content-section" style="display:none;">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Historial de Pedidos</h1>
                    <div class="mt-4 text-center text-sm text-gray-500 md:text-left">
                        <p class="font-semibold text-gray-700 mb-2">ID de Usuario:</p>
                        <div class="bg-gray-200 p-2 rounded-lg break-words">
                            <span id="userIdDisplayOrders">Cargando...</span>
                        </div>
                    </div>
                    <div id="orders-list" class="space-y-6 mt-8">
                        <!-- Orders will be dynamically generated here -->
                    </div>
                </div>

                <!-- Payment Methods Section -->
                <div id="payment-methods-section" class="content-section">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Métodos de Pago</h1>

                    <!-- Emotional and Security Message -->
                    <div
                        class="bg-green-50 text-green-700 p-4 rounded-xl flex items-center space-x-3 mb-6 border border-green-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.362a2 2 0 010 2.724l-7.25 7.25a2 2 0 01-2.724 0l-7.25-7.25a2 2 0 010-2.724l7.25-7.25a2 2 0 012.724 0l7.25 7.25z" />
                        </svg>
                        <p class="text-sm">Tus datos están protegidos con estándares internacionales de seguridad.
                            Puedes modificar o eliminar tus métodos en cualquier momento.</p>
                    </div>

                    <!-- Payment Methods List -->
                    <div id="payment-methods-list" class="space-y-4">
                        <!-- Payment methods will be rendered here -->
                    </div>

                    <!-- Add New Method Button -->
                    <button id="addPaymentMethodBtn"
                        class="w-full bg-amber-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-amber-600 transition-all duration-300 transform hover:scale-105 mt-6">
                        Agregar nuevo método
                    </button>
                </div>

            </div>
        </div>
    </main>

    <!-- Custom Modal for Confirmation -->
    <div id="confirmationModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"
        style="display: none;">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <p class="text-lg font-semibold mb-6 text-gray-800">¿Estás seguro de que quieres eliminar tu perfil?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmDeleteBtn"
                    class="bg-red-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-red-700 transition-colors">Sí,
                    eliminar</button>
                <button id="cancelDeleteBtn"
                    class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-400 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="messageModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"
        style="display: none;">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <p id="messageText" class="text-lg font-semibold mb-6 text-gray-800"></p>
            <button id="closeMessageModalBtn"
                class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-colors">Aceptar</button>
        </div>
    </div>

    <!-- Custom Modal for Adding Payment Method -->
    <div id="addPaymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"
        style="display: none;">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-4">Agregar nuevo método de pago</h3>
            <p class="text-gray-500 mb-6 text-sm">No te preocupes, no guardamos tus datos sin tu consentimiento. Tus
                pagos están 100% seguros.</p>
            <form id="paymentForm" class="space-y-4">
                <div>
                    <label for="paymentType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de método</label>
                    <select id="paymentType" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                        <option value="">Selecciona un tipo</option>
                        <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                        <option value="Billetera Digital">Billetera Digital</option>
                        <option value="Transferencia Bancaria">Transferencia Bancaria</option>
                    </select>
                </div>
                <div>
                    <label for="cardAlias" class="block text-sm font-medium text-gray-700 mb-1">Alias (ej. "Tarjeta
                        personal")</label>
                    <input type="text" id="cardAlias" placeholder="Mi tarjeta principal" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                </div>
                <div>
                    <label for="cardNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de
                        tarjeta</label>
                    <input type="text" id="cardNumber" placeholder="xxxx xxxx xxxx xxxx" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de
                            expiración</label>
                        <input type="text" id="expiryDate" placeholder="MM/AA" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                    </div>
                    <div>
                        <label for="cvv" class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
                        <input type="text" id="cvv" placeholder="xxx" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="isDefault" class="rounded text-blue-600 focus:ring-blue-500">
                    <label for="isDefault" class="text-sm text-gray-700">Establecer como principal</label>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" id="cancelPaymentBtn"
                        class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full hover:bg-gray-400 transition-colors">Cancelar</button>
                    <button type="submit"
                        class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full hover:bg-blue-700 transition-colors">Guardar
                        método</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Footer -->
    <footer class="bg-blue-950 text-white py-12 mt-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- About Section -->
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-amber-500">Ecommerce.bo</h3>
                    <p class="text-gray-400 text-sm">
                        Tu tienda en línea de confianza para encontrar los mejores productos.
                    </p>
                </div>

                <!-- Quick Links -->
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-amber-500">Enlaces Rápidos</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">Acerca de Nosotros</a>
                        </li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">Contacta con
                                Nosotros</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">Términos y
                                Condiciones</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">Política de
                                Privacidad</a></li>
                    </ul>
                </div>

                <!-- Contact Info -->
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-amber-500">Contacto</h3>
                    <p class="text-gray-400 text-sm">123 Calle Falsa, Ciudad, País</p>
                    <p class="text-gray-400 text-sm">Email: info@ecommerce.bo</p>
                    <p class="text-400 text-sm">Teléfono: +123 456 7890</p>
                </div>
            </div>

            <!-- Copyright and Social Icons -->
            <div class="border-t border-gray-700 mt-8 pt-6 flex flex-col md:flex-row items-center justify-between">
                <p class="text-gray-400 text-sm">&copy; 2024 Ecommerce.bo. Todos los derechos reservados.</p>
                <div class="flex space-x-4 mt-4 md:mt-0">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Facebook">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M12 2C6.477 2 2 6.477 2 12c0 5.008 3.657 9.176 8.441 9.877V14.77H7.854v-2.738h2.587V10.1c0-2.56 1.564-3.96 3.844-3.96 1.107 0 2.053.197 2.332.285v2.463h-1.458c-1.213 0-1.446.577-1.446 1.423v1.86h2.894l-.47 2.738H12.92v6.607C17.343 21.176 21 17.008 21 12c0-5.523-4.477-10-10-10z" />
                        </svg>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Twitter">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M22.46 6c-.77.34-1.6.57-2.46.68.88-.53 1.55-1.37 1.87-2.38-.83.49-1.75.85-2.73 1.05C18.17 4.16 16.92 3.5 15.58 3.5c-2.35 0-4.26 1.91-4.26 4.26 0 .33.04.66.12.97-3.54-.18-6.68-1.87-8.78-4.43-.37.64-.58 1.38-.58 2.18 0 1.48.75 2.79 1.88 3.56-.7-.02-1.35-.22-1.92-.53v.05c0 2.06 1.47 3.79 3.42 4.18-.36.1-.74.15-1.13.15-.28 0-.55-.03-.81-.08.54 1.69 2.11 2.92 3.97 2.96-1.46 1.14-3.3 1.82-5.3 1.82-.35 0-.69-.02-1.03-.06 1.89 1.21 4.12 1.92 6.54 1.92 7.84 0 12.1-6.49 12.1-12.1 0-.19 0-.38-.01-.56.83-.6 1.55-1.35 2.11-2.2z" />
                        </svg>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Instagram">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M12 2.163c3.204 0 3.584.012 4.85.07c1.476.07 2.02.348 2.585.578.58.232 1.05.617 1.44 1.006.39.39.774.86 1.006 1.44.23.564.508 1.108.578 2.585.058 1.266.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.07 1.476-.348 2.02-.578 2.585-.232.58-.617 1.05-1.006 1.44-.39.39-.86.774-1.44 1.006-.564.23-.974.508-.578-2.585-.058-1.266-.07-1.646-.07-4.85s.012-3.584.07-4.85c.07-1.476.348-2.02.578-2.585.232-.58.617-1.05 1.006-1.44.39-.39.86-.774 1.44-1.006.564-.23.974-.508 2.585-.578 1.266-.058 1.646-.07 4.85-.07zm0 1.5c-3.183 0-3.558.012-4.793.069-1.39.06-1.896.33-2.31.493-.418.164-.784.382-1.132.73-.348.348-.566.714-.73 1.132-.163.414-.433.92-.493 2.31-.057 1.235-.069 1.61-.069 4.793s.012 3.558.069 4.793c.06 1.39.33 1.896.493 2.31.164.418.382.784.73 1.132.348.348.714.566 1.132.73.414.163.92.433 2.31.493 1.235.057 1.61.069 4.793.069s3.558-.012 4.793-.069c1.39-.06 1.896-.33 2.31-.493.418-.164.382-.784-.73-1.132-.348-.348-.714-.566-1.132-.73-.414-.163-.92-.433-2.31-.493-1.235-.057-1.61-.069-4.793-.069zm0 3.75a4.25 4.25 0 100 8.5 4.25 4.25 0 000-8.5zM12 15a3 3 0 110-6 3 3 0 010 6zm-3.5-6a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Set Firestore log level to debug
        setLogLevel('Debug');

        // Firestore private data path structure
        // /artifacts/{appId}/users/{userId}/{your_collection_name}/{documentId}
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let profileRef = null;
        let profilePictureDataUrl = null;

        const loadingDiv = document.getElementById('loading');
        const errorMessageDiv = document.getElementById('error-message');
        const profileForm = document.getElementById('profileForm');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const deleteProfileBtn = document.getElementById('deleteProfileBtn');
        const profileInputs = profileForm.querySelectorAll('input');
        const addressList = document.getElementById('addressList');
        const addAddressBtn = document.getElementById('addAddressBtn');
        const addressFormContainer = document.getElementById('addressFormContainer');
        const addressForm = document.getElementById('addressForm');
        const cancelAddressBtn = document.getElementById('cancelAddressBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const closeMessageModalBtn = document.getElementById('closeMessageModalBtn');

        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const contentSections = document.querySelectorAll('.content-section');

        const userIdDisplay = document.getElementById('userIdDisplay');
        const userIdDisplayAddresses = document.getElementById('userIdDisplayAddresses');
        const userIdDisplayOrders = document.getElementById('userIdDisplayOrders');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const profilePicture = document.getElementById('profilePicture');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const ordersList = document.getElementById('orders-list');

        const paymentMethodsList = document.getElementById('payment-methods-list');
        const addPaymentMethodBtn = document.getElementById('addPaymentMethodBtn');
        const addPaymentModal = document.getElementById('addPaymentModal');
        const paymentForm = document.getElementById('paymentForm');
        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');

        const showMessage = (text, type = 'error') => {
            messageText.textContent = text;
            messageModal.style.display = 'flex';
        };

        closeMessageModalBtn.addEventListener('click', () => {
            messageModal.style.display = 'none';
        });

        const toggleEditMode = (isEditing) => {
            profileInputs.forEach(input => input.disabled = !isEditing);
            editProfileBtn.style.display = isEditing ? 'none' : 'inline-block';
            saveProfileBtn.style.display = isEditing ? 'inline-block' : 'none';
        };

        const setActiveSection = (sectionId) => {
            sidebarLinks.forEach(link => {
                link.classList.remove('active', 'bg-blue-600', 'text-white');
                link.classList.add('text-gray-700', 'bg-white', 'hover:bg-gray-100');
            });
            contentSections.forEach(section => {
                section.style.display = 'none';
            });

            const activeLink = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeLink) {
                activeLink.classList.add('active', 'bg-blue-600', 'text-white', 'hover:bg-blue-700');
                document.getElementById(`${sectionId}-section`).style.display = 'block';
            }
        };

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = e.currentTarget.dataset.section;
                setActiveSection(sectionId);
            });
        });

        // Initialize authentication
        const setupAuth = async () => {
            loadingDiv.style.display = 'block';
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase auth error:", error);
                showMessage('Error de autenticación. Por favor, intente de nuevo.');
            }
        };

        // Listen for auth state changes and fetch user data
        onAuthStateChanged(auth, (user) => {
            loadingDiv.style.display = 'none';
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                userIdDisplayAddresses.textContent = userId;
                userIdDisplayOrders.textContent = userId;
                profileRef = doc(db, 'artifacts', appId, 'users', userId, 'profiles', 'userProfile');

                // Listen for real-time updates to the profile
                onSnapshot(profileRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('firstName').value = data.firstName || '';
                        document.getElementById('lastName').value = data.lastName || '';
                        document.getElementById('email').value = data.email || '';
                        document.getElementById('password').value = data.password || '';
                        document.getElementById('phone').value = data.phone || '';
                        document.getElementById('ciNit').value = data.ciNit || '';

                        // Update UI with fetched data
                        const fullName = `${data.firstName || ''} ${data.lastName || ''}`.trim();
                        userNameDisplay.textContent = fullName || 'Nuevo Usuario';
                        profilePicture.src = data.profilePicture || 'https://placehold.co/120x120/E2E8F0/A0AEC0?text=Foto';

                        renderAddresses(data.addresses || []);
                    } else {
                        // Profile document does not exist, initialize empty state
                        renderAddresses([]);
                        userNameDisplay.textContent = 'Nuevo Usuario';
                        profilePicture.src = 'https://placehold.co/120x120/E2E8F0/A0AEC0?text=Foto';
                    }
                }, (error) => {
                    console.error("Firestore snapshot error:", error);
                    showMessage('Error al cargar datos del perfil. Por favor, recargue la página.');
                });

                // Generate and render mock order data
                const mockOrders = generateMockOrders();
                renderOrderHistory(mockOrders);

                // Load and render payment methods from localStorage
                renderPaymentMethods();

            } else {
                console.log("User signed out.");
                userIdDisplay.textContent = 'No autenticado';
                userIdDisplayAddresses.textContent = 'No autenticado';
                userIdDisplayOrders.textContent = 'No autenticado';
                userNameDisplay.textContent = 'Usuario Anónimo';
            }
        });

        const renderAddresses = (addresses) => {
            addressList.innerHTML = '';
            if (addresses.length === 0) {
                addressList.innerHTML = `<li class="text-gray-500 text-center">Aún no hay direcciones guardadas.</li>`;
                return;
            }

            addresses.forEach((address, index) => {
                const li = document.createElement('li');
                li.className = `bg-white p-4 rounded-xl shadow border border-gray-200 flex items-start space-x-4 transition-transform duration-200 ${address.isPrimary ? 'border-blue-500 shadow-md transform scale-100' : ''}`;
                li.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">
                            ${address.isPrimary ? '<span class="text-blue-600">Principal</span> - ' : ''}
                            ${address.calle}, ${address.numero}
                        </p>
                        <p class="text-sm text-gray-500">${address.zona ? `${address.zona}, ` : ''}${address.ciudad}, ${address.provincia}, ${address.departamento}</p>
                        <p class="text-xs text-gray-400 mt-1">${address.referencias}</p>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button class="delete-address-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors" data-index="${index}" title="Eliminar Dirección">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        ${!address.isPrimary ? `
                        <button class="set-primary-btn bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors" data-index="${index}" title="Establecer como Principal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </button>` : ''}
                    </div>
                `;
                addressList.appendChild(li);
            });

            // Add event listeners to new buttons
            document.querySelectorAll('.delete-address-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index, 10);
                    handleDeleteAddress(index);
                });
            });

            document.querySelectorAll('.set-primary-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index, 10);
                    handleSetPrimary(index);
                });
            });
        };

        const handleSaveProfile = async (e) => {
            e.preventDefault();
            if (!userId) {
                showMessage('No se pudo guardar el perfil. Por favor, intente de nuevo.');
                return;
            }

            const formData = new FormData(profileForm);
            const data = Object.fromEntries(formData.entries());

            try {
                // Fetch current addresses to merge
                const docSnap = await getDoc(profileRef);
                const currentAddresses = docSnap.exists() ? docSnap.data().addresses || [] : [];

                await setDoc(profileRef, {
                    ...data,
                    profilePicture: profilePictureDataUrl || profilePicture.src,
                    addresses: currentAddresses
                }, { merge: true });

                showMessage('Perfil guardado con éxito.', 'success');
                toggleEditMode(false);
            } catch (error) {
                console.error("Error saving profile:", error);
                showMessage('Error al guardar el perfil. Por favor, intente de nuevo.');
            }
        };

        const handleAddAddress = async (e) => {
            e.preventDefault();
            if (!userId) {
                showMessage('No se pudo agregar la dirección.');
                return;
            }

            const departamento = document.getElementById('departamento').value;
            const provincia = document.getElementById('provincia').value;
            const ciudad = document.getElementById('ciudad').value;
            const zona = document.getElementById('zona').value;
            const calle = document.getElementById('calle').value;
            const numero = document.getElementById('numero').value;
            const referencias = document.getElementById('referencias').value;
            const isPrimary = document.getElementById('isPrimary').checked;

            const newAddress = { departamento, provincia, ciudad, zona, calle, numero, referencias, isPrimary };

            try {
                const docSnap = await getDoc(profileRef);
                let currentAddresses = docSnap.exists() ? docSnap.data().addresses || [] : [];

                if (isPrimary) {
                    currentAddresses.forEach(addr => addr.isPrimary = false);
                }
                currentAddresses.push(newAddress);

                await setDoc(profileRef, { addresses: currentAddresses }, { merge: true });

                addressForm.reset();
                addressFormContainer.style.display = 'none';
                addAddressBtn.style.display = 'block';
                showMessage('Dirección agregada con éxito.', 'success');
            } catch (error) {
                console.error("Error adding address:", error);
                showMessage('Error al agregar la dirección. Intente de nuevo.');
            }
        };

        const handleDeleteAddress = async (index) => {
            if (!userId) return;

            try {
                const docSnap = await getDoc(profileRef);
                let addresses = docSnap.exists() ? docSnap.data().addresses || [] : [];

                addresses.splice(index, 1);

                await setDoc(profileRef, { addresses: addresses }, { merge: true });
                showMessage('Dirección eliminada.', 'success');
            } catch (error) {
                console.error("Error deleting address:", error);
                showMessage('Error al eliminar la dirección.');
            }
        };

        const handleSetPrimary = async (index) => {
            if (!userId) return;

            try {
                const docSnap = await getDoc(profileRef);
                let addresses = docSnap.exists() ? docSnap.data().addresses || [] : [];

                addresses.forEach((addr, i) => addr.isPrimary = (i === index));

                await setDoc(profileRef, { addresses: addresses }, { merge: true });
                showMessage('Dirección principal actualizada.', 'success');
            } catch (error) {
                console.error("Error setting primary address:", error);
                showMessage('Error al establecer la dirección principal.');
            }
        };

        const handleDeleteProfile = async () => {
            if (!userId) return;
            confirmationModal.style.display = 'flex';
        };

        confirmDeleteBtn.addEventListener('click', async () => {
            confirmationModal.style.display = 'none';
            if (!userId) return;
            try {
                await deleteDoc(profileRef);
                showMessage('Perfil eliminado con éxito.', 'success');
                profileForm.reset();
                addressList.innerHTML = `<li class="text-gray-500 text-center">El perfil ha sido eliminado.</li>`;
                toggleEditMode(false);
            } catch (error) {
                console.error("Error deleting profile:", error);
                showMessage('Error al eliminar el perfil. Intente de nuevo.');
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
        });

        // Image Handling
        profilePictureInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageDataUrl = event.target.result;
                    if (imageDataUrl.length > 1048576) {
                        showMessage('La imagen es demasiado grande. Por favor, suba una imagen de menos de 1MB.');
                        return;
                    }
                    profilePicture.src = imageDataUrl;
                    profilePictureDataUrl = imageDataUrl;
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Order History Section Functions ---

        // Function to generate mock order data
        const generateMockOrders = () => {
            return [
                {
                    id: 'ORD-12345678',
                    date: '25 de Septiembre de 2024',
                    status: 'Entregado',
                    total: 155.00,
                    paymentMethod: 'Tarjeta de Crédito',
                    shippingAddress: { calle: 'Calle San Martín', numero: '256', ciudad: 'La Paz' },
                    products: [
                        { name: 'Auriculares Inalámbricos', quantity: 1, price: 99.99, image: 'https://placehold.co/80x80/285324/FFF?text=Audifonos' },
                        { name: 'Mouse Gamer RGB', quantity: 1, price: 55.01, image: 'https://placehold.co/80x80/60A5FA/FFF?text=Mouse' }
                    ],
                    isFavorited: false
                },
                {
                    id: 'ORD-98765432',
                    date: '20 de Septiembre de 2024',
                    status: 'En tránsito',
                    total: 75.50,
                    paymentMethod: 'PayPal',
                    shippingAddress: { calle: 'Avenida 6 de Agosto', numero: '123', ciudad: 'Cochabamba' },
                    products: [
                        { name: 'Cargador Rápido USB-C', quantity: 2, price: 25.00, image: 'https://placehold.co/80x80/FBBF24/FFF?text=Cargador' },
                        { name: 'Cable HDMI 4K', quantity: 1, price: 25.50, image: 'https://placehold.co/80x80/81C784/FFF?text=Cable' }
                    ],
                    isFavorited: false
                },
                {
                    id: 'ORD-11223344',
                    date: '10 de Septiembre de 2024',
                    status: 'Cancelado',
                    total: 200.00,
                    paymentMethod: 'Transferencia Bancaria',
                    shippingAddress: { calle: 'Plaza 24 de Septiembre', numero: '88', ciudad: 'Santa Cruz' },
                    products: [
                        { name: 'Monitor LED 27 pulgadas', quantity: 1, price: 200.00, image: 'https://placehold.co/80x80/A1A1AA/FFF?text=Monitor' }
                    ],
                    isFavorited: true
                }
            ];
        };

        // Function to render the order history
        const renderOrderHistory = (orders) => {
            ordersList.innerHTML = '';
            if (orders.length === 0) {
                ordersList.innerHTML = `<p class="text-gray-500 text-center">Aún no has realizado ningún pedido.</p>`;
                return;
            }

            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'bg-white rounded-2xl shadow-lg border border-gray-200 p-6 transition-all duration-300 transform hover:scale-[1.01] order-item';

                const productListHtml = order.products.map(product => `
                    <div class="flex items-center space-x-4 py-2 border-b last:border-b-0 border-gray-100">
                        <img src="${product.image}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover border border-gray-200">
                        <div class="flex-grow">
                            <p class="font-medium text-gray-800">${product.name}</p>
                            <p class="text-sm text-gray-500">Cantidad: ${product.quantity}</p>
                        </div>
                        <p class="font-semibold text-gray-800">$${product.price.toFixed(2)}</p>
                    </div>
                `).join('');

                orderCard.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between pb-4 border-b border-gray-200 mb-4">
                        <div class="mb-4 md:mb-0">
                            <h3 class="font-bold text-lg text-gray-800">Pedido #${order.id}</h3>
                            <div class="flex items-center space-x-2 text-sm text-gray-500">
                                <span class="text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 012-2V7a2 2 0 01-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </span>
                                <span>${order.date}</span>
                                <button class="copy-order-id-btn p-1 rounded-full hover:bg-gray-200 transition-colors" data-order-id="${order.id}" title="Copiar número de pedido">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                                        <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-semibold p-2 rounded-full text-white ${getStatusColor(order.status)}">${order.status}</span>
                            <button class="order-details-toggle bg-gray-200 text-gray-700 p-2 rounded-full hover:bg-gray-300 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="order-details space-y-4 pt-4" style="display: none;">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-center text-sm text-gray-600">
                            <div>
                                <p class="font-semibold text-gray-800">Total Pagado: <span class="text-lg text-green-600 font-bold">$${order.total.toFixed(2)}</span></p>
                                <p>Método de Pago: ${order.paymentMethod}</p>
                            </div>
                            <div class="md:text-right mt-4 md:mt-0">
                                <p class="font-semibold text-gray-800">Dirección de Envío:</p>
                                <p class="text-gray-500">${order.shippingAddress.calle}, ${order.shippingAddress.numero}</p>
                                <p class="text-gray-500">${order.shippingAddress.ciudad}</p>
                            </div>
                        </div>

                        <div class="space-y-3 pt-4">
                            <h4 class="font-semibold text-gray-800">Productos:</h4>
                            <div class="bg-gray-50 rounded-xl p-4 space-y-2">
                                ${productListHtml}
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 mt-4">
                            <button class="reorder-btn flex-grow md:flex-grow-0 bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-blue-700 transition-colors">
                                <div class="flex items-center justify-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M3 1a1 1 0 000 2h10a1 1 0 001-1v-1a1 1 0 10-2 0v1H5V1a1 1 0 00-2 0zM15.5 3.5a1.5 1.5 0 00-1.5 1.5v2.245L15 8.783v2.42A2 2 0 0017 13.5v-6a2 2 0 00-2-2z" />
                                    </svg>
                                    <span>Volver a comprar</span>
                                </div>
                            </button>
                            <button class="invoice-btn flex-grow md:flex-grow-0 bg-gray-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-gray-600 transition-colors">
                                <div class="flex items-center justify-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2-10h4a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 002-2v0a2 2 0 012-2h2a2 2 0 012 2v2z" />
                                    </svg>
                                    <span>Factura</span>
                                </div>
                            </button>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mt-4 text-sm font-medium">
                            <button class="action-btn text-gray-600 bg-gray-100 py-2 px-4 rounded-full hover:bg-gray-200 transition-colors">
                                <div class="flex items-center space-x-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938-1.562a8.55 8.55 0 01-1.63 2.083 8.583 8.583 0 008.204 8.204 8.55 8.55 0 012.083-1.63l.117-.06a8.55 8.55 0 011.63-2.083 8.583 8.583 0 008.204-8.204 8.55 8.55 0 01-1.63-2.083l-.06-.117a8.55 8.55 0 01-2.083-1.63 8.583 8.583 0 00-8.204-8.204 8.55 8.55 0 01-2.083 1.63l-.117.06z" />
                                    </svg>
                                    <span>Solicitar devolución</span>
                                </div>
                            </button>
                            <button class="action-btn text-gray-600 bg-gray-100 py-2 px-4 rounded-full hover:bg-gray-200 transition-colors">
                                <div class="flex items-center space-x-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.338-.879 1.547-.879 1.885 0l1.791 4.636 4.86.381c.969.076 1.341 1.258.623 1.832l-3.6 2.768 1.401 4.546c.29.936-.714 1.638-1.503 1.07l-4.226-3.058-4.226 3.058c-.789.568-1.793-.134-1.504-1.07l1.401-4.546-3.6-2.768c-.718-.574-.346-1.756.623-1.832l4.86-.381 1.791-4.636z" />
                                    </svg>
                                    <span>Valorar productos</span>
                                </div>
                            </button>
                            <button class="action-btn text-gray-600 bg-gray-100 py-2 px-4 rounded-full hover:bg-gray-200 transition-colors">
                                <div class="flex items-center space-x-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2v-6a2 2 0 012-2h2a2 2 0 002-2V5a2 2 0 012-2h2a2 2 0 012 2v0a2 2 0 012 2v2z" />
                                    </svg>
                                    <span>Contactar soporte</span>
                                </div>
                            </button>
                        </div>
                    </div>
                `;
                ordersList.appendChild(orderCard);
            });

            // Attach event listeners for the new elements
            document.querySelectorAll('.order-details-toggle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderItem = e.currentTarget.closest('.order-item');
                    if (orderItem) {
                        const details = orderItem.querySelector('.order-details').style;
                        details.display = details.display === 'none' ? 'block' : 'none';
                        e.currentTarget.querySelector('svg').classList.toggle('rotate-180');
                    }
                });
            });

            document.querySelectorAll('.copy-order-id-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.dataset.orderId;
                    const el = document.createElement('textarea');
                    el.value = orderId;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showMessage('Número de pedido copiado.', 'success');
                });
            });

            document.querySelectorAll('.reorder-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showMessage('Los productos se han agregado a tu carrito. ¡Gracias por volver a comprar!');
                });
            });

            document.querySelectorAll('.invoice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showMessage('Tu factura se está descargando...');
                });
            });

            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showMessage('Has solicitado una acción. Nuestro equipo de soporte se pondrá en contacto contigo pronto.');
                });
            });

        };

        const getStatusColor = (status) => {
            switch (status) {
                case 'Entregado':
                    return 'bg-green-500';
                case 'En tránsito':
                    return 'bg-blue-500';
                case 'Cancelado':
                    return 'bg-red-500';
                default:
                    return 'bg-gray-500';
            }
        };


        // --- Payment Methods Section Functions ---

        // Local storage key for payment methods
        const PAYMENT_METHODS_KEY = 'paymentMethods';

        const getPaymentMethods = () => {
            const methods = localStorage.getItem(PAYMENT_METHODS_KEY);
            return methods ? JSON.parse(methods) : [];
        };

        const savePaymentMethods = (methods) => {
            localStorage.setItem(PAYMENT_METHODS_KEY, JSON.stringify(methods));
            renderPaymentMethods();
        };

        const renderPaymentMethods = () => {
            const methods = getPaymentMethods();
            paymentMethodsList.innerHTML = ''; // Clear the list

            if (methods.length === 0) {
                paymentMethodsList.innerHTML = `<p class="text-gray-500 text-center py-4">No tienes métodos de pago guardados.</p>`;
                return;
            }

            methods.forEach((method, index) => {
                const card = document.createElement('div');
                card.className = `payment-card bg-white p-6 rounded-2xl shadow border border-gray-200 flex items-center justify-between ${method.isPrincipal ? 'border-blue-500 shadow-lg' : ''}`;

                let iconSVG = '';
                switch (method.type) {
                    case 'Tarjeta de Crédito':
                        iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>`;
                        break;
                    case 'Billetera Digital':
                        iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`;
                        break;
                    case 'Transferencia Bancaria':
                        iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`;
                        break;
                }

                const lastFour = method.cardNumber.slice(-4);

                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        ${iconSVG}
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg text-gray-800">${method.alias}</span>
                                ${method.isPrincipal ? `<span class="bg-blue-100 text-blue-700 text-xs font-semibold px-2 py-1 rounded-full">Principal</span>` : ''}
                                ${isExpiringSoon(method.expiry) ? `<span class="bg-yellow-100 text-yellow-700 text-xs font-semibold px-2 py-1 rounded-full">Expira pronto</span>` : ''}
                            </div>
                            <p class="text-sm text-gray-500">**** **** **** ${lastFour}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-9a1 1 0 00-2 0v1a1 1 0 102 0V9zm4 0a1 1 0 00-2 0v1a1 1 0 102 0V9zm-5 4a1 1 0 001 1h4a1 1 0 100-2h-4a1 1 0 00-1 1z" clip-rule="evenodd" />
                                </svg>
                                <span class="text-xs text-gray-500">Datos seguros</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button data-action="set-principal" data-index="${index}" class="bg-gray-100 text-gray-600 p-2 rounded-full hover:bg-gray-200 transition-colors" title="Establecer como principal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                        <button data-action="delete" data-index="${index}" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors" title="Eliminar método">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                paymentMethodsList.appendChild(card);
            });

            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', handlePaymentAction);
            });
        };

        const isExpiringSoon = (expiry) => {
            const [month, year] = expiry.split('/').map(Number);
            const today = new Date();
            const expiryDate = new Date(2000 + year, month - 1); // 2000 + YY
            const diffMonths = (expiryDate.getFullYear() - today.getFullYear()) * 12 + (expiryDate.getMonth() - today.getMonth());
            return diffMonths <= 3;
        };

        const handlePaymentAction = (e) => {
            const action = e.currentTarget.dataset.action;
            const index = parseInt(e.currentTarget.dataset.index);
            let methods = getPaymentMethods();

            if (action === 'delete') {
                if (methods[index].isPrincipal && methods.length > 1) {
                    showMessage('No puedes eliminar el método de pago principal si tienes otros métodos. Por favor, establece otro como principal primero.');
                    return;
                }
                methods.splice(index, 1);
                savePaymentMethods(methods);
                showMessage('Método de pago eliminado.', 'success');
            } else if (action === 'set-principal') {
                methods.forEach((m, i) => m.isPrincipal = (i === index));
                savePaymentMethods(methods);
                showMessage('Método de pago establecido como principal.', 'success');
            }
        };

        const handleAddPaymentMethod = (e) => {
            e.preventDefault();
            const alias = document.getElementById('cardAlias').value;
            const type = document.getElementById('paymentType').value;
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expiry = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;
            const isDefault = document.getElementById('isDefault').checked;

            if (!/^\d{16}$/.test(cardNumber)) {
                showMessage('Por favor, introduce un número de tarjeta de 16 dígitos válido.');
                return;
            }
            if (!/^\d{2}\/\d{2}$/.test(expiry)) {
                showMessage('Por favor, introduce una fecha de expiración válida (MM/AA).');
                return;
            }
            if (!/^\d{3,4}$/.test(cvv)) {
                showMessage('Por favor, introduce un CVV válido (3 o 4 dígitos).');
                return;
            }

            const newMethod = { type, alias, cardNumber, expiry, cvv, isPrincipal: isDefault };

            let methods = getPaymentMethods();
            if (isDefault) {
                methods.forEach(m => m.isPrincipal = false);
            } else if (methods.length === 0) {
                newMethod.isPrincipal = true;
            }
            methods.push(newMethod);

            savePaymentMethods(methods);
            addPaymentModal.style.display = 'none';
            paymentForm.reset();
            showMessage('Método de pago agregado con éxito. ¡Gracias por confiar en nosotros!');
        };

        // Event Listeners
        editProfileBtn.addEventListener('click', () => toggleEditMode(true));
        profileForm.addEventListener('submit', handleSaveProfile);
        deleteProfileBtn.addEventListener('click', handleDeleteProfile);

        addAddressBtn.addEventListener('click', () => {
            addressFormContainer.style.display = 'block';
            addAddressBtn.style.display = 'none';
        });

        cancelAddressBtn.addEventListener('click', () => {
            addressFormContainer.style.display = 'none';
            addAddressBtn.style.display = 'block';
            addressForm.reset();
        });

        addressForm.addEventListener('submit', handleAddAddress);

        addPaymentMethodBtn.addEventListener('click', () => {
            addPaymentModal.style.display = 'flex';
        });

        cancelPaymentBtn.addEventListener('click', () => {
            addPaymentModal.style.display = 'none';
        });

        paymentForm.addEventListener('submit', handleAddPaymentMethod);


        // Initial setup
        setupAuth();
    </script>
</body>

</html>